# ADR 归档 (Archived ADRs)

> 本文件存放已稳定、不再变更的历史架构决策记录。
> 当前 ADR 请查看 [protocol-adr.md](protocol-adr.md)

---

## ADR-001: 智能层隔离协议 (Intelligence Layer Isolation Protocol)

### 状态
已实施 ✅ 归档

### 日期
2026-01-01

### 背景
随着 AI 协作的深入，规则文件逐渐臃肿，且 AI 辅助工具开始与业务代码产生环境冲突。需要建立清晰的边界和隔离机制。

### 决策
1. **物理与逻辑隔离**：将所有 AI 规则、脚本、环境统一收口至 `.agent` 目录，并实施"智能层隔离 (ILI)"
2. **资产化 (Assetization)**：将 `.agent` 设计为自包含的数字资产，支持跨项目无缝迁移
3. **防腐蚀 (Anti-corrosion)**：严禁工具依赖污染业务代码，严禁业务逻辑依赖 AI 工具
4. **长期主义 (Long-termism)**：建立演进式 Bug 预防机制，确保开发经验不随技术栈更迭而流失

### 后果
- 实现了 AI 协作的标准化与解耦
- 降低了 Token 消耗
- 提升了跨项目协作的确定性

---

## ADR-002: 引擎与实例数据解耦 (Engine-Instance Data Decoupling)

### 状态
已实施 ✅ 归档

### 日期
2026-01-01

### 背景
AI 在更新治理引擎时，容易将当前项目的业务名称硬编码进通用规则文件，导致引擎失去通用性。

### 决策
1. **目录分离**：
   - `core/` - 引擎文件（通用规则）
   - `project/` - 实例文件（项目特定信息）
2. **定义实例契约**：引入 `project/context.md` 作为引擎的"输入接口"
3. **清理通用规则**：移除 `core/` 中所有特定项目的名词
4. **建立自检机制**：在 `scripts/lint-protocol.py` 中实现"去项目化"审查

### 后果
- 确保了治理引擎的"纯净度"
- 引擎可以跨项目无缝迁移
- `core/` 成为真正的标准化资产

---

## ADR-003: 同步测试协议 (Synchronous Testing Protocol)

### 状态
已实施 ✅ 归档

### 日期
2026-01-04

### 背景
随着项目规模扩大，仅靠后期补测难以保证新功能的质量，且容易遗漏边界情况。

### 决策
1. **强制同步**：要求在开发任何新功能时，必须同步产出测试方案或自动化测试脚本
2. **交付标准**：未包含测试方案的功能交付将被视为"不完整交付"

### 后果
- 提升了代码的鲁棒性
- 降低了回归测试的成本
- 确保了功能的持续可验证性

---

## ADR-004: 测试数据动态隔离协议 (Dynamic Test Data Isolation)

### 状态
已实施 ✅ 归档

### 日期
2026-01-04

### 背景
固定命名的测试数据（如 `test_admin`）极易与开发者的手动测试数据冲突，导致测试失败或误删有用数据。

### 决策
1. **动态 RunID**：强制要求测试脚本生成随机 `RunID` 并注入数据名称
2. **专用前缀**：统一使用 `autotest_` 作为自动化测试数据的唯一识别前缀
3. **幂等清理**：测试开始前必须扫描并清理所有匹配前缀的残留数据

### 后果
- 实现了测试环境与开发环境的逻辑隔离
- 支持多实例并发测试
- 消除了命名冲突风险

---

## ADR-005: 协议层独立化 (Protocol Layer Independence)

### 状态
已实施 ✅ 归档

### 日期
2026-01-01

### 背景
AI 协议层的决策与具体业务项目的决策混杂在一起，不利于协议层的通用化和资产化。

### 决策
1. 将 AI 协议层的 ADR 从业务 ADR 中剥离，建立独立的 `meta/protocol-adr.md`
2. 将 AI 协议层视为一个独立的项目进行版本化和演进管理
3. 业务 ADR 保留在 `project/adr/` 目录

### 后果
- 强化了协议层的"资产"属性
- 协议层能够更清晰地记录自身的进化逻辑
- 协议演进不受业务项目干扰

---

## ADR-006: 协议瘦身与 Token 分析 (Protocol Slimming & Token Analysis)

### 状态
已实施 ✅ 归档

### 日期
2026-01-06

### 背景
随着 .agent 协议的不断演进，文档体积逐渐膨胀，导致：
- AI 会话时 Token 消耗过大
- 重复内容分散在多个文件中
- 部分过时内容未及时清理

需要建立机制来监控和优化协议的 Token 效率。

### 决策
1. **Token 分析脚本**：在 `scripts/token-counter.py` 创建 Token 统计工具，分析各文件的 Token 占用
2. **协议内容清理**：
   - 移除冗余和重复内容
   - 合并功能相近的文档
   - 精简过度详细的示例
3. **Token 预算意识**：在编写协议文档时，需考虑 Token 成本
4. **定期审查机制**：建议每月审查协议 Token 占用情况

### 后果
- 协议总 Token 数得到有效控制
- 提升了 AI 会话的成本效率
- 建立了协议"瘦身"的量化标准

---

*归档日期: 2026-01-23*
*归档原因: 基础架构决策已稳定，不再频繁变更*
